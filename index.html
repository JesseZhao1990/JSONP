<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Jsonp by JesseZhao1990</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Jsonp</h1>
      <h2 class="project-tagline">总结JSONP</h2>
      <a href="https://github.com/JesseZhao1990/JSONP" class="btn">View on GitHub</a>
      <a href="https://github.com/JesseZhao1990/JSONP/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/JesseZhao1990/JSONP/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="jsonp" class="anchor" href="#jsonp" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>JSONP</h1>

<p>要了解jsonp.首先要了解同源策略，什么是同源策略呢？</p>

<h2>
<a id="同源策略same-origin-policy" class="anchor" href="#%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5same-origin-policy" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>同源策略(Same Origin Policy)</h2>

<p>浏览器出于安全方面的考虑，只允许与同域下的接口交互。
也就是说javascript只可以操作自己域下的东西，不能操作其他域下的东西。比如百度下javascript是不可操作谷歌下的页面。</p>

<h3>
<a id="同域指的是" class="anchor" href="#%E5%90%8C%E5%9F%9F%E6%8C%87%E7%9A%84%E6%98%AF" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>同域指的是？</h3>

<p>同协议：如都是http或者https</p>

<p>同域名：如都是baidu.com</p>

<p>同端口：如都是80端口</p>

<p>比如： 用户打开了 页面: <a href="http://baidu.com%EF%BC%8C">http://baidu.com，</a> 当前页面下的 js 向 <a href="http://baidu.com/xxx">http://baidu.com/xxx</a> 的接口发 ajax 请求，浏览器是允许的。但假如向: <a href="http://google.com/xxx">http://google.com/xxx</a> 发ajax请求则会被浏览器阻止掉。</p>

<h3>
<a id="那-jsonp是什么呢" class="anchor" href="#%E9%82%A3-jsonp%E6%98%AF%E4%BB%80%E4%B9%88%E5%91%A2" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>那 JSONP是什么呢？</h3>

<p>HTML 中 script 标签可以加载其他域下的js，比如我们经常引入一个其他域下线上cdn的jQuery。那如何利用这个特性实现从其他域下获取数据呢？</p>

<p>这样试试：</p>

<pre><code>&lt;script src="http://api.jirengu.com/weather.php?callback=showData"&gt;&lt;/script&gt;

</code></pre>

<p>这个请求到达后端后，后端会去解析callback这个参数获取到字符串showData，在发送数据做如下处理：</p>

<pre><code>之前后端返回数据： {"city": "hangzhou", "weather": "晴天"}
现在后端返回数据： showData({"city": "hangzhou", "weather": "晴天"})

</code></pre>

<p>前端script标签在加载数据后会把 「showData({"city": "hangzhou", "weather": "晴天"})」做为 js 来执行，这实际上就是调用showData这个函数，同时参数是 {"city": "hangzhou", "weather": "晴天"}。</p>

<p>用户只需要在加载提前在页面定义好showData这个全局函数，在函数内部处理参数即可。</p>

<pre><code>&lt;script&gt;
    function showData(ret){
        console.log(ret);
    }
&lt;/script&gt;
&lt;script src="http://api.jirengu.com/weather.php?callback=showData"&gt;&lt;/script&gt;

</code></pre>

<p>「原来这就是 JSONP(JSON with padding)，总结一下：」
1. JSONP是通过 script 标签加载数据的方式去获取数据当做 JS 代码来执行</p>

<ol>
<li>提前在页面上声明一个函数，函数名通过接口传参的方式传给后台，后台解析到函数名后在原始数据上「包裹」这个函数名，发送给前端。换句话说，JSONP 需要对应接口的后端的配合才能实现。</li>
</ol>

<p>原理很简单，但用起来代码好丑陋，做个封装如何？</p>

<pre><code>
function jsonp(setting){
  setting.data = setting.data || {}
  setting.key = setting.key||'callback'
  setting.callback = setting.callback||function(){} 
  setting.data[setting.key] = '__onGetData__'

  window.__onGetData__ = function(data){
    setting.callback (data);
  }

  var script = document.createElement('script')
  var query = []
  for(var key in setting.data){
    query.push( key + '='+ encodeURIComponent(setting.data[key]) )
  }
  script.src = setting.url + '?' + query.join('&amp;')
  document.head.appendChild(script)
  document.head.removeChild(script)

}

jsonp({
  url: 'http://api.jirengu.com/weather.php',
  callback: function(ret){
    console.log(ret)
  }
})

jsonp({
  url: 'http://photo.sina.cn/aj/index',
  key: 'jsoncallback',
  data: {
    page: 1,
    cate: 'recommend'
  },
  callback: function(ret){
    console.log(ret)
  }
})

</code></pre>

<p>演示地址：<a href="http://codepen.io/zhaojianxin/pen/KgXoAG?editors=0011">点击开始演示</a></p>

<p>文章来源：</p>

<p>1.<a href="https://zhuanlan.zhihu.com/p/22600501">https://zhuanlan.zhihu.com/p/22600501</a></p>

<p>2.<a href="http://blog.csdn.net/navy_xue/article/details/40016453">http://blog.csdn.net/navy_xue/article/details/40016453</a></p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/JesseZhao1990/JSONP">Jsonp</a> is maintained by <a href="https://github.com/JesseZhao1990">JesseZhao1990</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
